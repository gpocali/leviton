FROM debian:stretch
MAINTAINER Gregory Pocali <1571781+gpocali@users.noreply.github.com>

# This docker is used to control MyLeviton switches and turn lights on at sunset and off at sunrise at a user defined brightness
# 3 Environmental Variables must be defined
# - leviton_username
# - leviton_password
# - leviton_percent
# For security purposes, pass these variables through a file using env_file in the run command
# ToDo: Change to Copy instead of embedding script

RUN apt-get update; apt-get -y install wget g++ make git php-cli php-curl coreutils procps; \
mkdir /tmp/sunwait; cd /tmp/sunwait; git clone https://github.com/risacher/sunwait.git; cd sunwait; make; cp sunwait /usr/local/bin; cd /tmp/; rm -Rf sunwait; \
apt-get -y remove wget g++ make git; apt-get -y autoremove; apt-get clean; rm -rf /var/lib/apt/lists/*; echo "IyEvdXNyL2Jpbi9waHAKPD9waHAKJExFVklUT05fUk9PVCA9ICdodHRwczovL215Lmxldml0b24uY29tL2FwaSc7CiRVU0VSTkFNRSA9IGdldGVudigibGV2aXRvbl91c2VybmFtZSIpOwokUEFTU1dPUkQgPSBnZXRlbnYoImxldml0b25fcGFzc3dvcmQiKTsKJE9OUEVSQ0VOVCA9IGdldGVudigibGV2aXRvbl9wZXJjZW50Iik7CgokZXJyb3IgPSBmYWxzZTsKaWYoJFVTRVJOQU1FID09PSBmYWxzZSl7CgllY2hvICJFbnZpcm9ubWVudGFsIFZhcmlhYmxlICdsZXZpdG9uX3VzZXJuYW1lJyBub3Qgc2V0LlxuIjsKCSRlcnJvciA9IHRydWU7Cn0KaWYoJFBBU1NXT1JEID09PSBmYWxzZSl7CgllY2hvICJFbnZpcm9ubWVudGFsIFZhcmlhYmxlICdsZXZpdG9uX3Bhc3N3b3JkJyBub3Qgc2V0LlxuIjsKICAgICAgICAkZXJyb3IgPSB0cnVlOwp9CmlmKCRPTlBFUkNFTlQgPT09IGZhbHNlKXsKCWVjaG8gIkVudmlyb25tZW50YWwgVmFyaWFibGUgJ2xldml0b25fcGVyY2VudCcgbm90IHNldC5cbiI7CiAgICAgICAgJGVycm9yID0gdHJ1ZTsKfQppZigkZXJyb3IpewoJZXhpdDsKfQoKaWYodHJpbShzaGVsbF9leGVjKCJwcyAtYXV4IHwgZ3JlcCAnIi4kYXJndlswXS4iIHN0YXJ0JyB8IGdyZXAgLXYgZ3JlcCB8IHdjIC1sIikpID4gMSl7CgllY2hvICJUaGVyZSBpcyBhbm90aGVyIGluc3RhbmNlIGFscmVhZHkgcnVubmluZywgZXhpdGluZy5cbiI7CglleGl0Owp9CgppZighaXNzZXQoJGFyZ3ZbMV0pKXsKICAgICAgICBlY2hvICJBcmd1bWVudCBSZXF1aXJlZC5cbiI7CiAgICAgICAgZXhpdDsKfQpmdW5jdGlvbiBsZXZfcmVxdWVzdCgkYXBpLCAkYm9keSwgJG1ldGhvZCwgJHNlc3Npb25JZCA9IG51bGwpewogICAgICAgIGdsb2JhbCAkTEVWSVRPTl9ST09UOwogICAgICAgICR1cmkgPSAkTEVWSVRPTl9ST09ULiRhcGk7CgogICAgICAgIGlmKCRtZXRob2QgPT0gIlBPU1QiKXsKICAgICAgICAgICAgICAgICRib2R5ID0ganNvbl9lbmNvZGUoJGJvZHkpOwogICAgICAgICAgICAgICAgJHBvc3QgPSAxOwogICAgICAgIH0gZWxzZSBpZigkbWV0aG9kID09ICJHRVQiKXsKICAgICAgICAgICAgICAgIC8vR0VUCiAgICAgICAgICAgICAgICAkcG9zdCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vUFVUCiAgICAgICAgICAgICAgICAkYm9keSA9IGpzb25fZW5jb2RlKCRib2R5KTsKICAgICAgICAgICAgICAgICRwb3N0ID0gMDsKICAgICAgICB9CgoKICAgICAgICAkY2ggPSBjdXJsX2luaXQoKTsKICAgICAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfVVJMLCAkdXJpKTsKICAgICAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfUkVUVVJOVFJBTlNGRVIsIHRydWUpOwogICAgICAgIGN1cmxfc2V0b3B0KCRjaCwgQ1VSTE9QVF9GT0xMT1dMT0NBVElPTiwgdHJ1ZSk7CiAgICAgICAgaWYoJHBvc3QgPT0gMSl7CiAgICAgICAgICAgICAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfUE9TVCwgMSk7CiAgICAgICAgICAgICAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfUE9TVEZJRUxEUywgJGJvZHkpOwogICAgICAgIH0gZWxzZSBpZigkbWV0aG9kID09ICJHRVQiKSB7CiAgICAgICAgICAgICAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfQ1VTVE9NUkVRVUVTVCwgJ0dFVCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfQ1VTVE9NUkVRVUVTVCwgIlBVVCIpOwogICAgICAgICAgICAgICAgY3VybF9zZXRvcHQoJGNoLCBDVVJMT1BUX1BPU1RGSUVMRFMsICRib2R5KTsKICAgICAgICB9CiAgICAgICAgY3VybF9zZXRvcHQoJGNoLCBDVVJMT1BUX1NTTF9WRVJJRllQRUVSLCAxKTsKICAgICAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfSFRUUEhFQURFUiwgYXJyYXkoCiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgICdDb250ZW50LUxlbmd0aDogJyAuIHN0cmxlbigkYm9keSksCiAgICAgICAgICAgICAgICAnQXV0aG9yaXphdGlvbjogJyAuICRzZXNzaW9uSWQpCiAgICAgICAgKTsKICAgICAgICAkb3V0cHV0WyJyZXN1bHQiXSA9IGpzb25fZGVjb2RlKGN1cmxfZXhlYygkY2gpLCB0cnVlKTsKICAgICAgICAkb3V0cHV0WyJyZXNwb25zZUluZm8iXSA9IGN1cmxfZ2V0aW5mbygkY2gpOwoKICAgICAgICByZXR1cm4gJG91dHB1dDsKfQoKZnVuY3Rpb24gbGV2X2xvZ2luKCRlbWFpbCwgJHBhc3N3b3JkKXsKICAgICAgICAkYm9keSA9IGFycmF5KCdlbWFpbCcgPT4gJGVtYWlsLCAncGFzc3dvcmQnID0+ICRwYXNzd29yZCwgJ2NsaWVudElkJyA9PiAnbGV2ZGItZWNoby1wcm90bycsICdyZWdpc3RlcmVkVmlhJyA9PiAnbXlMZXZpdG9uJyk7CiAgICAgICAgJHJlcSA9IGxldl9yZXF1ZXN0KCcvUGVyc29uL2xvZ2luJywgJGJvZHksICJQT1NUIik7CiAgICAgICAgaWYgKCRyZXFbJ3Jlc3BvbnNlSW5mbyddWydodHRwX2NvZGUnXSAhPSAnMjAwJyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGVjaG8gIlJlc3BvbnNlICIuJHJlcVsncmVzcG9uc2VJbmZvJ11bJ2h0dHBfY29kZSddLiI6ICIuJHJlcVsncmVzdWx0J107CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJHJlcVsncmVzdWx0J107Cn0KCmZ1bmN0aW9uIGxldl9sb2dvdXQoJHNlc3Npb24pewogICAgICAgICRib2R5ID0gW107CiAgICAgICAgJHJlcSA9IGxldl9yZXF1ZXN0KCcvUGVyc29uL2xvZ291dCcsICRib2R5LCAiUE9TVCIsICRzZXNzaW9uWydpZCddKTsKICAgICAgICBpZiAoJHJlcVsncmVzcG9uc2VJbmZvJ11bJ2h0dHBfY29kZSddICE9ICcyMDAnICYmICRyZXFbJ3Jlc3BvbnNlSW5mbyddWydodHRwX2NvZGUnXSAhPSAnMjA0Jyl7CiAgICAgICAgICAgICAgICB2YXJfZHVtcCgkcmVxKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9Cn0KCmZ1bmN0aW9uIGxldl9yZXNpZGVudGlhbF9wZXJtaXNzaW9ucygkc2Vzc2lvbil7CiAgICAgICAgJHJlcSA9IGxldl9yZXF1ZXN0KCIvUGVyc29uLyIuJHNlc3Npb25bJ3VzZXJJZCddLiIvcmVzaWRlbnRpYWxQZXJtaXNzaW9ucyIsIG51bGwsICJHRVQiLCAkc2Vzc2lvblsnaWQnXSk7CiAgICAgICAgaWYgKCRyZXFbJ3Jlc3BvbnNlSW5mbyddWydodHRwX2NvZGUnXSAhPSAnMjAwJyAmJiAkcmVxWydyZXNwb25zZUluZm8nXVsnaHR0cF9jb2RlJ10gIT0gJzIwNCcpewogICAgICAgICAgICAgICAgdmFyX2R1bXAoJHJlcSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmVxWydyZXN1bHQnXTsKfQoKZnVuY3Rpb24gbGV2X3Jlc2lkZW5jZXMoJHNlc3Npb24sICRyZXNpZGVudGlhbF9hY2NvdW50X2lkKXsKICAgICAgICAkcmVxID0gbGV2X3JlcXVlc3QoIi9SZXNpZGVudGlhbEFjY291bnRzLyIuJHJlc2lkZW50aWFsX2FjY291bnRfaWQuIi9SZXNpZGVuY2VzIiwgbnVsbCwgIkdFVCIsICRzZXNzaW9uWydpZCddKTsKICAgICAgICBpZiAoJHJlcVsncmVzcG9uc2VJbmZvJ11bJ2h0dHBfY29kZSddICE9ICcyMDAnKXsKICAgICAgICAgICAgICAgIHZhcl9kdW1wKCRyZXEpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmVxWydyZXN1bHQnXTsKfQoKZnVuY3Rpb24gbGV2X2lvdF9zd2l0Y2hlcygkc2Vzc2lvbiwgJHJlc2lkZW5jZV9pZCl7CiAgICAgICAgJHJlcSA9IGxldl9yZXF1ZXN0KCIvUmVzaWRlbmNlcy8iLiRyZXNpZGVuY2VfaWQuIi9pb3RTd2l0Y2hlcyIsIG51bGwsICJHRVQiLCAkc2Vzc2lvblsnaWQnXSk7CiAgICAgICAgaWYgKCRyZXFbJ3Jlc3BvbnNlSW5mbyddWydodHRwX2NvZGUnXSAhPSAnMjAwJyl7CiAgICAgICAgICAgICAgICB2YXJfZHVtcCgkcmVxKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJHJlcVsncmVzdWx0J107Cn0KCmZ1bmN0aW9uIGxldl91cGRhdGVfc3dpdGNoKCRzZXNzaW9uLCAkc3dpdGNoX2lkLCAkcG93ZXIsICRicmlnaHRuZXNzKXsKICAgICAgICAkYm9keSA9IFsgJ2JyaWdodG5lc3MnID0+ICRicmlnaHRuZXNzLCAncG93ZXInID0+ICRwb3dlciBdOwogICAgICAgICRyZXEgPSBsZXZfcmVxdWVzdCgiL0lvdFN3aXRjaGVzLyIuJHN3aXRjaF9pZCwgJGJvZHksICJQVVQiLCAkc2Vzc2lvblsnaWQnXSk7CiAgICAgICAgaWYgKCRyZXFbJ3Jlc3BvbnNlSW5mbyddWydodHRwX2NvZGUnXSAhPSAnMjAwJyAmJiAkcmVxWydyZXNwb25zZUluZm8nXVsnaHR0cF9jb2RlJ10gIT0gJzIwNCcpewogICAgICAgICAgICAgICAgdmFyX2R1bXAoJHJlcSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmVxWydyZXN1bHQnXTsKfQoKJHNlc3Npb24gPSBudWxsOwoKaWYgKGlzX251bGwoJHNlc3Npb24pKXsKICAgICAgICAkc2Vzc2lvbiA9IGxldl9sb2dpbigkVVNFUk5BTUUsICRQQVNTV09SRCk7Cn0KCmlmIChpc19udWxsKCRzZXNzaW9uKSl7CiAgICAgICAgZWNobyAnTG9naW4gZmFpbGVkLlxuJzsKICAgICAgICBleGl0Owp9CgokbGF1bmNoID0gZmFsc2U7CmlmICgkYXJndlsxXSA9PSAic3RhcnQiKXsKCSRsYXVuY2ggPSB0cnVlOwp9IGVsc2UgaWYgKCRhcmd2WzFdID09IDApewoJJHN0YXRlID0gJ09GRic7CgkkcGVyY2VudCA9ICcwJzsKfSBlbHNlIHsKCSRzdGF0ZSA9ICdPTic7CgkkcGVyY2VudCA9ICRhcmd2WzFdOwp9CgokcGVybSA9IGxldl9yZXNpZGVudGlhbF9wZXJtaXNzaW9ucygkc2Vzc2lvbik7CiRyZXNpZGVuY2VzID0gbGV2X3Jlc2lkZW5jZXMoJHNlc3Npb24sICRwZXJtWzBdWydyZXNpZGVudGlhbEFjY291bnRJZCddKTsKZWNobyAiU2VsZWN0ZWQgUmVzaWRlbmNlOiAiLiRyZXNpZGVuY2VzWzBdWyduYW1lJ10uIiAoIi4kcmVzaWRlbmNlc1swXVsnZ2VvcG9pbnQnXVsnbGF0J10uIiwgIi4kcmVzaWRlbmNlc1swXVsnZ2VvcG9pbnQnXVsnbG5nJ10uIilcbiI7CmlmKCRsYXVuY2gpewoJJGN1cnJlbnQgPSB0cmltKHNoZWxsX2V4ZWMoInN1bndhaXQgcG9sbCBkYXlsaWdodCAiLiRyZXNpZGVuY2VzWzBdWydnZW9wb2ludCddWydsYXQnXS4iTiAiLiRyZXNpZGVuY2VzWzBdWydnZW9wb2ludCddWydsbmcnXS4iRSIpKTsKCSRzd2l0Y2hlcyA9IGxldl9pb3Rfc3dpdGNoZXMoJHNlc3Npb24sICRyZXNpZGVuY2VzWzBdWydpZCddKTsKCWVjaG8gJGN1cnJlbnQuIlxuIjsKCWZvcmVhY2goJHN3aXRjaGVzIGFzICRzd2l0Y2gpewoJCWlmKCRjdXJyZW50ID09ICJOSUdIVCIpewoJCQkvL05pZ2h0IC0gVHVybiBTd2l0Y2ggT24KCQkJJHN0YXRlID0gIk9OIjsKCQkJJHBlcmNlbnQgPSAkT05QRVJDRU5UOwoJCX0gZWxzZSB7CgkJCS8vRGF5IC0gVHVybiBTd2l0Y2ggT0ZGCgkJCSRzdGF0ZSA9ICJPRkYiOwoJCQkkcGVyY2VudCA9IDA7CgkJfQoJCWlmKCRzd2l0Y2hbJ3Bvd2VyJ10gIT0gJHN0YXRlIHx8ICRzd2l0Y2hbJ2JyaWdodG5lc3MnXSAhPSAkcGVyY2VudCl7CgkJCWVjaG8gZGF0ZSgiWS1tLWQgSDppLnMgVCIpLiIgLSBJbml0aWFsaXppbmcgU3RhdGU6IFR1cm5pbmcgc3dpdGNoICIuJHN3aXRjaFsnbmFtZSddLiIgIi4kc3RhdGUuIiBhdCAiLiRwZXJjZW50LiIlXG4iOwoJCQlsZXZfdXBkYXRlX3N3aXRjaCgkc2Vzc2lvbiwgJHN3aXRjaFsnaWQnXSwgJHN0YXRlLCAkcGVyY2VudCk7CgkJfQoJfQoJbGV2X2xvZ291dCgkc2Vzc2lvbik7CglzbGVlcCgzMCk7CgkkbGFzdEhvdXIgPSAtMTsKCXdoaWxlKHRydWUpewoJCS8vUnVuIGF0IG5vb24gYW5kIG1pZG5pZ2h0CgkJaWYoZGF0ZSgiSCIpJTEyID09IDAgJiYgZGF0ZSgiSCIpICE9ICRsYXN0SG91ciB8fCAkbGFzdEhvdXIgPT0gLTEpewoJCQlpZih0cmltKHNoZWxsX2V4ZWMoInN1bndhaXQgcG9sbCBkYXlsaWdodCAiLiRyZXNpZGVuY2VzWzBdWydnZW9wb2ludCddWydsYXQnXS4iTiAiLiRyZXNpZGVuY2VzWzBdWydnZW9wb2ludCddWydsbmcnXS4iRSIpKSA9PSAiTklHSFQiKXsKCQkJCS8vTklHSFQgLSBUdXJuIE9mZiBMaWdodCBhdCBzdW5yaXNlCgkJCQllY2hvIHNoZWxsX2V4ZWMoInN1bndhaXQgd2FpdCByaXNlICIuJHJlc2lkZW5jZXNbMF1bJ2dlb3BvaW50J11bJ2xhdCddLiJOICIuJHJlc2lkZW5jZXNbMF1bJ2dlb3BvaW50J11bJ2xuZyddLiJFICYmICIuJGFyZ3ZbMF0uIiAwIik7CgkJCX0gZWxzZSB7CgkJCQkvL0RheSAtIFR1cm4gT24gTGlnaHQgYXQgc3Vuc2V0CgkJCQllY2hvIHNoZWxsX2V4ZWMoInN1bndhaXQgd2FpdCBzZXQgIi4kcmVzaWRlbmNlc1swXVsnZ2VvcG9pbnQnXVsnbGF0J10uIk4gIi4kcmVzaWRlbmNlc1swXVsnZ2VvcG9pbnQnXVsnbG5nJ10uIkUgJiYgIi4kYXJndlswXS4iICIuJE9OUEVSQ0VOVCk7CgkJCX0KCQkJJGxhc3RIb3VyID0gZGF0ZSgiSCIpOwoJCX0KCQkvL1NsZWVwIDMwIE1pbnV0ZXMKCQlzbGVlcCgxODAwKTsKCX0KCWV4aXQ7Cn0KCiRzd2l0Y2hlcyA9IGxldl9pb3Rfc3dpdGNoZXMoJHNlc3Npb24sICRyZXNpZGVuY2VzWzBdWydpZCddKTsKCmZvcmVhY2goJHN3aXRjaGVzIGFzICRzd2l0Y2gpewogICAgICAgIGVjaG8gZGF0ZSgiWS1tLWQgSDppLnMgVCIpLiIgLSBUdXJuaW5nIHN3aXRjaCAiLiRzd2l0Y2hbJ25hbWUnXS4iICIuJHN0YXRlLiIgYXQgIi4kcGVyY2VudC4iJVxuIjsKICAgICAgICBsZXZfdXBkYXRlX3N3aXRjaCgkc2Vzc2lvbiwgJHN3aXRjaFsnaWQnXSwgJHN0YXRlLCAkcGVyY2VudCk7Cn0KbGV2X2xvZ291dCgkc2Vzc2lvbik7Cgo/Pgo=" | base64 -d > /usr/bin/leviton.php; chmod +x /usr/bin/leviton.php;

# Above text is Base64 Encoded for use in command

ENTRYPOINT ["php", "/usr/bin/leviton.php", "start"]

